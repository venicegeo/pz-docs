# Pz Service Controller

The Piazza Core ServiceController manages and executes web services external to the Piazza core architecture (User Services).  It provides a REST API allowing developers to perform web service management activities.  The ServiceController also listens to Kafka topics dispatched from the Piazza Core Dispatcher, responds and handles web service management and execution Kafka messages.  Using the ServiceController, developers can:

1. Register web services for search/discovery (See pz-search for details)
2. Update information on the web service (e.g. URL, name, version and other metadata)
3. Remove a web service from the registry
4. View details about registered web services
5. Execute a registered web service

The figure below shows the high level architecture of Piazza and how the ServiceController interacts with different components.

![alt text](https://cloud.githubusercontent.com/assets/12052181/13731572/c6d3e148-e942-11e5-9fab-12b51a48fd4f.jpg "ServiceController in Piazza")

## API Overviews

[Sprint 3 - ServiceController API Overview - 3/31/2016](https://github.com/venicegeo/pz-servicecontroller/files/199832/Piazza-ServiceController-Overview.pptx)


## How to Use

### Prerequisites

The ServiceContoller, version 1.0, uses the following to build and run:

1. Java Development Kit 1.8 (http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html)
2. Maven
3. MongoDB
4. *Oracle VM VirtualBox (for running the ServiceController on individual VMs)
5. *Vagrant 
6. **[[UUID Generator|Pz-UuidGen]]
7. **[[Logger|Pz-Logger]]
8. **[[Alerter|Pz-Alerter]]
9. **[[Discover|Pz-Discover]]
10. **[[Kafka|Pz-Kafka]]
11. **[[Gateway/Dispatch/JobManager|Pz-Gateway]]

_* Software needed to use Vagrant to standup a mock Piazza Core cluster_

_**These services are part of the Piazza Core. When these services are not available, the ServiceController defaults to standalone behavior._
## Obtaining the ServiceController
The repo containing the ServiceController is located in github at the following location: https://github.com/venicegeo/pz-servicecontroller
Clone this repo to obtain the latest copy.  The ServiceController can be built and run standalone or from within predefined virtual machines using Vagrant.

## Building the Source

Before using the ServiceController, decide whether you want to run the ServiceController with supporting Piazza Core Services and VirtualBox VMs (with MongoDB, Kafka, etc..), or if you want to run the ServiceController standalone.

### Standalone Option

To build the ServiceController, run   
 _mvn clean install_ from the _**mainServiceController**_ directory.  
This will build the ServiceController and produce an executable jar which is placed in the **mainServiceController/target** directory.  

The name of the jar will be **_piazzaServiceController-(version number).BUILD-SNAPSHOT.jar_**.

### Vagrant

Start up a Windows PowerShell **as administrator**.  Navigate to the mainServiceController/conf directory.  Issue the command **Vagrant up**. This command will create the serviceregistry and serviceregistrydb VMs. 

## Running the ServiceController

The ServiceController is a Spring Boot application and can be run directly from the command line.
It uses an _**application.properties**_ file which contains port, hostname, database name and other information used by the ServiceController.  When the Piazza Discover Service is not available, the Service Controller utilizes information in the application.properties file to connect to supporting services.

_**application.properties**_ files are located in the mainServiceController/conf directory.  To run the ServiceController, locally, you have to choose _**application-local.properties**_ and place it in the location that the ServiceController is started from, in the _src/main/resources_ directory or in the classpath used by the ServiceController.  

When the Piazza [[Discover|Pz-Discover]] service is running and the location/api is specified in the application.properties file, the ServiceController uses the values registered in the Discover service to communicate with things such as Kafka, MongoDB and other Piazza Core Services.
   

**Values provided by the Discover service supersede values defined in the application.properties file. **   

....
server.port=8082  
servicecontroller.host=localhost
kafka.group=Test_Group
mongo.db.name=Piazza
mongo.db.collection.name=Services
core.discoverapi=/api/v1/resources
core.discoverservice=pz-discover.cf.piazzageo.io
core.db=/mongodb
core.kafka=/kafka
core.uuid=/pz-uuidgen
core.logger=/pz-logger
log4j.category.org.springframework=ERROR
logging.level.org.venice.piazza.servicecontroller=INFO
logging.level.org.springframework.web=INFO
endpoints.shutdown.enabled=true

# Values overwritten by pz-discover if not up then these are the defaults
core.uuidservice=localhost:12340/uuid
core.logservice=localhost:12341/log
kafka.host=localhost
kafka.port=9092
mongo.host=localhost
mongo.port=27017
....




To run the ServiceController from the _**mainServiceController/conf**_ directory, run the following command:

_> java â€“jar <path to the location of the servicecontroller.jar>/ piazzaServiceController-(version number).BUILD-SNAPSHOT.jar_

This will run the ServiceController, after initializing, the following message will be displayed:

`_o.v.p.servicecontroller.Application : Started Application in 8.994 seconds (JVM running for 9.658)_`

### Running with the Discover Service

For the ServiceController to be aware of where the Discover is located, the ServiceController has to be run by setting the _**core.discoverservice**_ property and _**core.discoverapi**_ property.  The _mainServiceController/conf_ directory contains the _**application-cf.properties**_ file which has these properties set to use the Discover service.


### Debugging

The ServiceController provides logging messages at an **INFO** level displaying informational messages that highlight the progress of the application at coarse-grained level.  To debug, the ServiceController, run the ServiceController specifying the _logging.level.org.venice.piazza.servicecontroller_ property as **DEBUG**

_>java -jar -Dlogging.level.org.venice.piazza.servicecontroller=DEBUG piazzaServiceController-(version number).BUILD-SNAPSHOT.jar_  

When the Piazza core [[Logger|Pz-Logger]] service is available, the ServiceController uses it to log additional messages.

## Getting Started With the REST API

The ServiceController comes with some sample services to help with getting started with using the ServiceController API.  

| Jumpstart Service | Description | Example URL |
|-----------------|:----------|:---|
| toLower | Converts a string to lowercase. **POST** method | http://pz-servicecontroller.stage.geointservices.io/jumpstart/string/toLower?aString=testing |
| toUpper | Converts a string to uppercase. **POST** method | http://pz-servicecontroller.stage.geointservices.io/jumpstart/string/toUpper?aString=testing |
| convert | Converts a string to UPPER or LOWER case.  **POST** method | http://pz-servicecontroller.stage.geointservices.io/jumpstart/string/convert { "theString":"testing", "conversionType":"UPPER"} |
| moviequotewelcome | Takes an optional name as a parameter and provides a movie quote greeting to ServiceController users.  **GET** method | hhttp://pz-servicecontroller.stage.geointservices.io/jumpstart/moviequotewelcome?name=Marge or http://pz-servicecontroller.stage.geointservices.io/jumpstart/moviequotewelcome |

To become familiar with the ServiceController, use data transfer tools such as **cURL** or UI data transfer tools such as **Postman** ( https://www.getpostman.com/) to interact with the ServiceController REST API.

The ServiceController leverages Java object definitions defined the pz-jobcommon github repo (https://github.com/venicegeo/pz-jobcommon/tree/master/src/main/java/model/job/metadata) as definitions of the JSON used in the ServiceController REST API.

Piazza Core Resources are represented as _**ResourceMetadata**_ within the Piazza Core.

### Registering a Service

Before the ServiceController can manage a service, the service has to be registered. To do this, utilize the ServiceController's _**registerService**_ service passing in ResourceMetadata JSON.  As of now, there are no mandatory fields, but at a bare minimum register enough information so that other developers can discover and use the service.

Below is an example of how to register a web service that uses the **POST** method, specifies the input parameters via URL key value pairs - in this case using the parameter aString.  This example registers the toLower Service  

....
http://pz-servicecontroller.stage.geointservices.io/servicecontroller/registerService  
{  
    "id" : "",
    "resourceMetadata" : {  
           "name":"The toLower Service",  
          "description":"Service to convert string to lower case",  
          "url":"http://pz-servicecontroller.cf.piazzageo.io/jumpstart/string/toLower",  
          "method":"POST"
    },
    "inputs" : [ {
    "name" : "aString",
    "minOccurs" : 1,
    "maxOccurs" : 1,
    "dataType" : {
      "type" : "urlparameter"
    },
    "metadata" : null,
    "formats" : null
  } ],
  "outputs" : [ {
    "name" : "Lower Case message",
    "minOccurs" : 1,
    "maxOccurs" : 1,
    "dataType" : {
      "mimeType" : "application/json",
      "type" : "text"
    },
    "metadata" : {
      "about" : "ConvertToLowerCase",
      "href" : null,
      "role" : null,
      "title" : "Lower Case Text"
    },
    "formats" : [ {
      "mimeType" : "application/json",
      "encoding" : null,
      "schema" : null,
      "maximumMegabytes" : null,
      "dataType" : null
    } ]
  } ]
}
....

The response from the ServiceController will be a JSON message providing the ResourceID for the toLower Resource.  

....
{"resourceId":"123-345-456846434418332"}
....

_Once registered, users, should utilize the ResourceID to perform any functions on the registered service._

_**A response of {"resourceId":""} means that the service was not properly registered within the ServiceController.  Be sure MongoDB and other required software is up and running.**_

To register a service that uses the **POST** method requiring JSON as the RequestBody, send the following payload to the registerService:

....
{
  "id" : "",
    "resourceMetadata" : {  
           "name":"The toLower Service",  
          "description":"Service to convert string to upper or lower case",  
          "url":"http://localhost:8086/jumpstart/string/convert",  
          "method":"POST"
    },
    "inputs" : [ {
    "name" : "BODY",
    "minOccurs" : 1,
    "maxOccurs" : 1,
    "dataType" : {
      "type" : "body"
    },
    "metadata" : null,
    "formats" : null
  } ],
  "outputs" : [ {
    "name" : "Converted message",
    "minOccurs" : 1,
    "maxOccurs" : 1,
    "dataType" : {
      "mimeType" : "application/json",
      "type" : "text"
    },
    "metadata" : {
      "about" : "Converted message",
      "href" : null,
      "role" : null,
      "title" : "Converted Text"
    },
    "formats" : [ {
      "mimeType" : "application/json",
      "encoding" : null,
      "schema" : null,
      "maximumMegabytes" : null,
      "dataType" : null
    } ]
  } ]
}
....

To register a service that uses the **GET** example without URL parameters (as per a "pure" REST case), the process is the same but be sure to specify **GET** as the method.

....
{ 
    "id" : "",
    "resourceMetadata" : {  
           "name":"Movie Quote Welcome",  
          "description":"A web service that welcomes you to pz-servicecontroller",  
          "url":"http://pz-servicecontroller.stage.geointservices.io/jumpstart/moviequotewelcome",  
          "method":"GET"
    },
    
  "outputs" : [ {
    "name" : "Movie Quote",
    "minOccurs" : 1,
    "maxOccurs" : 1,
    "dataType" : {
      "mimeType" : "application/json",
      "type" : "text"
    },
    "metadata" : {
      "about" : "Movie Quote",
      "href" : null,
      "role" : null,
      "title" : "Movie Quote"
    },
    "formats" : [ {
      "mimeType" : "application/json",
      "encoding" : null,
      "schema" : null,
      "maximumMegabytes" : null,
      "dataType" : null
    } ]
  } ]

}
....


### Executing a Service

To execute a service, utilize the ServiceControllers _**executeService**_ API.  Below is an example of how to execute the toLower service that was registered in the previous section.

....
http://pz-servicecontroller.stage.geointservices.io/servicecontroller/executeService
{
  "serviceId" : "{{resourceId}}",
  "dataInputs" : {
    "aString" : {
      "type" : "text",
      "content" : "The rain in Spain"
    }
  }
}
....

The response will be:  

....
<200 OK,{"result":"it is raining today."},{Server=[Apache-Coyote/1.1], Content-Type=[application/json;charset=UTF-8], Content-Length=[33], Date=[Tue, 19 Jan 2016 13:27:33 GMT]}>
....

Executing the _moviequotewelcome_ previously registered would be done as follows:

....
{
  "serviceId" : "21e84123-6a50-4118-b600-d0721b19dd7d",
  "dataInputs" : {}
}
....

The response will be:

....
<200 OK,{"message":"I'm Ron Burgandyyyy?

HELLO Marge!!!!
Welcome to the piazza pz-servicecontroller!
Details on using pz-servicecontrollers are located on the github venice wiki!
"},{Server=[Apache-Coyote/1.1], Content-Type=[application/json;charset=UTF-8], Content-Length=[140], Date=[Tue, 19 Jan 2016 13:31:17 GMT]}>
....

### Executing a Service Sending JSON

To execute the convert service, do the following:

....
http://pz-servicecontroller.stage.geointservices.io/servicecontroller/executeService
{
  "serviceId" : "235e0e2d-5586-4ed2-898d-df78395151f7",
  "dataInputs" : {
    "" : {
      "content" : "{\"theString\":\"MARGE test\", \"conversionType\":\"UPPER\"}",
      "type" : "body",
      "mimeType" : "application/json"
    }
  }
}
....

### Coordinate Conversion Example

A coordinate conversion is an external service which allows users to convert geospatial coordinates.  To call this service directly, users of the service would formulate requests as depicted below:

....
http://pzsvc-coordinate-conversion.cf.piazzageo.io/location/convert?123456N 1234556W
http://pzsvc-coordinate-conversion.cf.piazzageo.io/location/convert?Benghazi
....

To register this service using the ServiceController API, send the following JSON:

....
http://pz-servicecontroller.stage.geointservices.io/servicecontroller/registerService  
 {   "id" : "",  
     "resourceMetadata" : {  
        "name" : "Coordinate Conversion",    
        "description" : "Read and convert various types of geospatial location formats",     
        "url" : "http://pzsvc-coordinate-conversion.cf.piazzageo.io/location/convert",     
        "method" : "GET"   },  
        "inputs" : [ {     
            "name" : "",   
             "minOccurs" : 1,   
             "maxOccurs" : 1,    
             "dataType" : {       "type" : "urlparameter"     },     
             "metadata" : null,     "formats" : null   } ], 
        "outputs" : [ {    
            "name" : "converted coordinates",   
            "minOccurs" : 1,     
            "maxOccurs" : 1,     
            "dataType" : {       "mimeType" : "application/json",       "type" : "text",       "type" : "text"     },  
            "metadata" : {       "about" : "Convert coordinates",   "href" : null,       "role" : null,       "title" : "coordinated coords"     },
            "formats" : [ {       "mimeType" : "application/json",       "encoding" : null,       "schema" : null,       "maximumMegabytes" : null,  
            "dataType" : null     } ]   } ] }    
....

A response should be sent back with the resourceId.

....
{"resourceId":"2cef8efc-a142-4426-9560-ba52d7c393cf"}
....

Once registered, to execute this service, perform the following specifying a Lat/Lon or Country:

....
http://pz-servicecontroller.stage.geointservices.io/servicecontroller/executeService
{
  "serviceId" : "16487d03-e244-48b8-b692-cde5e0699911",
  "dataInputs" : {
    "" : {
      "content" : "123456N 1234556W",
      "type" : "text"
    }
  }
}
or 
{
  "serviceId" : "16487d03-e244-48b8-b692-cde5e0699911",
  "dataInputs" : {
    "" : {
      "content" : "Benghazi",
      "type" : "text"
    }
  }
}
....

The ServiceController will respond with a json message sent from the service:

....
{
  "format": "geo-location",
  "dd": "32.11486, 20.06859",
  "dms": "320653.5N 0200406.92E",
  "latitude": 32.11486,
  "longitude": 20.06859,
  "mgrs": "34SDA1213253547",
  "name": "Benghazi, Libya"
}
....

### General Pz Service Operations  

The Pz ServiceController supports other Pz Service Operations..

**GET /**  on http://pz-servicecontroller.stage.geointservices.io/  
Provides a health check on Pz-ServiceController.
If the Pz-ServiceController is running you should see the following response:

....
Welcome from the Piazza Service Controller.
For details on running and using the ServiceController,
see Pz Service Controller for details.
....

**GET /admin/stats**   on http://pz-servicecontroller.stage.geointservices.io/   
Provides statistics on the Pz-ServiceController.

....
{"mem":382464,"mem.free":159813,"processors":2,"instance.uptime":18151962,"uptime":18166991,"systemload.average":1.05,"heap.committed":382464,"heap.init":382976,"heap.used":222650,"heap":382464,"threads.peak":31,"threads.daemon":27,"threads.totalStarted":37,"threads":31,"classes":11529,"classes.loaded":11529,"classes.unloaded":0,"gc.ps_scavenge.count":4900,"gc.ps_scavenge.time":13789,"gc.ps_marksweep.count":0,"gc.ps_marksweep.time":0,"httpsessions.max":-1,"httpsessions.active":0,"gauge.response.admin.stats":7.0,"gauge.response.root":102.0,"counter.status.200.root":1,"counter.status.302.admin.stats":1}
....

### Submitting User Service Requests

User Service requests can be submitted to Piazza via the [Pz Gateway](https://github.com/venicegeo/venice/wiki/Pz-Gateway).  All User Service requests are submitted using **POST /job**

For details on how to submit user service requests via the gateway, see [User Service Requests via the Gateway](https://github.com/venicegeo/venice/wiki/User-Service-Requests-via-the-Gateway)
